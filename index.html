<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årbol ORBAT - Explorador de Unidades</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .tree {
            margin-left: 20px;
            list-style-type: none;
        }

        .tree li {
            margin: 5px 0;
            cursor: pointer;
            user-select: none;
        }

        .tree .folder::before {
            content: "üìÇ ";
        }

        .tree .folder.open::before {
            content: "üìÅ ";
        }

        .tree .file::before {
            content: "üìÑ ";
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <h2>√Årbol de ORBAT - Explorador de Unidades</h2>
    <input type="file" id="fileInput" accept=".xml">
    <div id="treeContainer"></div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const xmlText = e.target.result;
                    parseXML(xmlText);
                };
                reader.readAsText(file);
            }
        });

        function parseXML(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const parties = xmlDoc.getElementsByTagName("party");

            const treeContainer = document.getElementById("treeContainer");
            treeContainer.innerHTML = ""; // Limpiar contenido anterior

            let ul = document.createElement("ul");
            ul.className = "tree";

            Array.from(parties).forEach(party => {
                const partyId = party.getAttribute("id");
                const partyName = party.getAttribute("name");

                let liParty = document.createElement("li");
                liParty.textContent = partyName;
                liParty.className = "folder";
                liParty.onclick = function (event) { toggleChildren(event, this); };

                let ulTactical = document.createElement("ul");
                ulTactical.className = "tree hidden";

                const tactical = party.getElementsByTagName("tactical")[0];
                if (tactical) {
                    extractFormations(tactical, ulTactical);
                }

                liParty.appendChild(ulTactical);
                ul.appendChild(liParty);
            });

            treeContainer.appendChild(ul);
        }


        function extractFormations(parentNode, parentElement) {
            const formations = parentNode.children;

            Array.from(formations).forEach(formation => {
                if (formation.tagName === "formation") {
                    const formationId = formation.getAttribute("id");
                    const formationName = formation.getAttribute("name");

                    let liFormation = document.createElement("li");
                    liFormation.textContent = formationName;
                    liFormation.className = "folder";
                    liFormation.onclick = function (event) { toggleChildren(event, this); };

                    let ulSubFormations = document.createElement("ul");
                    ulSubFormations.className = "tree hidden";

                    extractFormations(formation, ulSubFormations);
                    extractAutomats(formation, ulSubFormations);

                    liFormation.appendChild(ulSubFormations);
                    parentElement.appendChild(liFormation);
                }
            });
        }

        function extractAutomats(formationNode, parentElement) {
            // Buscar SOLO los hijos directos <automat>, evitando los de subniveles
            const automats = formationNode.children;

            Array.from(automats).forEach(automat => {
                if (automat.tagName === "automat") { // Solo nodos <automat>
                    const automatId = automat.getAttribute("id");
                    const automatName = automat.getAttribute("name");

                    let liAutomat = document.createElement("li");
                    liAutomat.textContent = automatName;
                    liAutomat.className = "folder"; // Es una carpeta
                    liAutomat.onclick = function (event) { toggleChildren(event, this); };

                    let ulUnits = document.createElement("ul");
                    ulUnits.className = "tree hidden";

                    extractUnits(automat, ulUnits); // Extraer <unit> dentro del <automat>

                    liAutomat.appendChild(ulUnits);
                    parentElement.appendChild(liAutomat);
                }
            });
        }

        function extractUnits(automatNode, parentElement) {
        const units = automatNode.children;

        Array.from(units).forEach(unit => {
            if (unit.tagName === "unit") {
                const unitId = unit.getAttribute("id");
                const unitName = unit.getAttribute("name");

                // Extraer los valores de `major-operational-state` y `operational-state`
                let equipments = unit.getElementsByTagName("equipments")[0];
                let majorState = equipments ? equipments.getAttribute("major-operational-state") : "N/A";
                let operationalState = equipments ? equipments.getAttribute("operational-state") : "N/A";

                // Crear el elemento de la unidad en la lista
                let liUnit = document.createElement("li");
                liUnit.className = "file";

                // Mostrar nombre de la unidad y sus estados operacionales
                liUnit.innerHTML = `${unitName} 
                    <span style="color:red;">[Major: ${majorState}]</span> 
                    <span style="color:green;">[Operational: ${operationalState}]</span>`;

                parentElement.appendChild(liUnit);
            }
        });
    }


        function toggleChildren(event, element) {
            event.stopPropagation(); // Evita que el clic se propague a niveles superiores

            let children = element.querySelector("ul");
            if (children) {
                let isHidden = children.classList.contains("hidden");
                children.classList.toggle("hidden", !isHidden); // Mostrar u ocultar los hijos
                element.classList.toggle("open", isHidden); // Cambia el estado del nodo
            }
        }

        // Asegurar que los nodos <unit> no afecten el √°rbol
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".file").forEach(file => {
                file.addEventListener("click", function (event) {
                    event.stopPropagation(); // Evita que el clic en <unit> cierre niveles superiores
                });
            });
        });

        function createBar(majorState, operationalState) {
            let barContainer = document.createElement("div");
            barContainer.style.display = "flex";
            barContainer.style.gap = "5px";
            barContainer.style.marginTop = "5px";

            let majorBar = document.createElement("div");
            majorBar.style.width = `${majorState * 20}%`;
            majorBar.style.height = "8px";
            majorBar.style.backgroundColor = "red";

            let opBar = document.createElement("div");
            opBar.style.width = `${operationalState * 20}%`;
            opBar.style.height = "8px";
            opBar.style.backgroundColor = "green";

            barContainer.appendChild(majorBar);
            barContainer.appendChild(opBar);

            return barContainer;
        }

        // Extrae los valores de operational-state de cada unit
        function extractUnitStates(unitElement) {
            let equipments = unitElement.querySelectorAll("equipment");
            let totalMajor = 0, totalOperational = 0, count = 0;

            equipments.forEach(equipment => {
                let majorState = parseInt(equipment.getAttribute("major-operational-state")) || 1;
                let operationalState = parseInt(equipment.getAttribute("operational-state")) || 1;
                totalMajor += majorState;
                totalOperational += operationalState;
                count++;
            });

            console.log(`Unit: ${unitElement.textContent.trim()} - Major: ${totalMajor}, Operational: ${totalOperational}, Count: ${count}`);

            return {
                majorState: count > 0 ? totalMajor / count : 1,
                operationalState: count > 0 ? totalOperational / count : 1
            };
        }

        function calculateAverages(node) {
            console.log("Procesando nodo:", node); // Ver si node es null o undefined

            if (!node) {
                console.log("‚ùå El nodo es null o undefined");
                return { avgMajor: 1, avgOperational: 1 };
            }

            let units = node.querySelectorAll(".unit");
            let totalMajor = 0, totalOperational = 0, count = 0;

            units.forEach(unit => {
                let states = extractUnitStates(unit);
                totalMajor += states.majorState;
                totalOperational += states.operationalState;
                count++;
            });

            console.log(`‚úî Formation/Automata: ${node.textContent.trim()} - Avg Major: ${totalMajor}, Avg Operational: ${totalOperational}, Count: ${count}`);

            return {
                avgMajor: count > 0 ? totalMajor / count : 1,
                avgOperational: count > 0 ? totalOperational / count : 1
            };
        }

        // Revisar si los nodos existen antes de procesarlos
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(() => {
                let formations = document.querySelectorAll(".automat, .formation");
                console.log("Formations encontrados:", formations.length);
                formations.forEach(node => {
                    let averages = calculateAverages(node);
                    let bar = createBar(averages.avgMajor, averages.avgOperational);
                    node.appendChild(bar);
                });
            }, 1000);
        });


        // Agrega las barras despu√©s de construir el √°rbol
        function addBarsToTree() {
            console.log("Ejecutando addBarsToTree...");

            document.querySelectorAll(".unit").forEach(unit => {
                let states = extractUnitStates(unit);
                let bar = createBar(states.majorState, states.operationalState);
                unit.appendChild(bar);
            });

            document.querySelectorAll(".automat, .formation").forEach(node => {
                let averages = calculateAverages(node);
                let bar = createBar(averages.avgMajor, averages.avgOperational);
                node.appendChild(bar);
            });

            console.log("Barras agregadas correctamente.");
        }



    </script>

</body>

</html>