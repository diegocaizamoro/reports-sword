<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årbol ORBAT - Explorador de Unidades</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .tree {
            margin-left: 20px;
            list-style-type: none;
        }

        .tree li {
            margin: 5px 0;
            cursor: pointer;
            user-select: none;
        }

        .tree .folder::before {
            content: "üìÇ ";
        }

        .tree .folder.open::before {
            content: "üìÅ ";
        }

        .tree .file::before {
            content: "üìÑ ";
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <h2>√Årbol de ORBAT - Explorador de Unidades</h2>
    <input type="file" id="fileInput" accept=".xml">
    <div id="treeContainer"></div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const xmlText = e.target.result;
                    parseXML(xmlText);
                };
                reader.readAsText(file);
            }
        });

        function parseXML(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const parties = xmlDoc.getElementsByTagName("party");

            const treeContainer = document.getElementById("treeContainer");
            treeContainer.innerHTML = ""; // Limpiar contenido anterior

            let ul = document.createElement("ul");
            ul.className = "tree";

            Array.from(parties).forEach(party => {
                const partyId = party.getAttribute("id");
                const partyName = party.getAttribute("name");

                let liParty = document.createElement("li");
                liParty.textContent = partyName;
                liParty.className = "folder";
                liParty.onclick = function (event) { toggleChildren(event, this); };

                let ulTactical = document.createElement("ul");
                ulTactical.className = "tree hidden";

                const tactical = party.getElementsByTagName("tactical")[0];
                if (tactical) {
                    extractFormations(tactical, ulTactical);
                }

                liParty.appendChild(ulTactical);
                ul.appendChild(liParty);
            });

            treeContainer.appendChild(ul);
        }


        function extractFormations(parentNode, parentElement) {
            const formations = parentNode.children;

            Array.from(formations).forEach(formation => {
                if (formation.tagName === "formation") {
                    const formationId = formation.getAttribute("id");
                    const formationName = formation.getAttribute("name");

                    let liFormation = document.createElement("li");
                    liFormation.textContent = formationName;
                    liFormation.className = "folder";
                    liFormation.onclick = function (event) { toggleChildren(event, this); };

                    let ulSubFormations = document.createElement("ul");
                    ulSubFormations.className = "tree hidden";

                    extractFormations(formation, ulSubFormations);
                    extractAutomats(formation, ulSubFormations);

                    liFormation.appendChild(ulSubFormations);
                    parentElement.appendChild(liFormation);
                }
            });
        }

        function extractAutomats(formationNode, parentElement) {
            const automats = formationNode.children;
            let totalMajor = 0, totalOperational = 0, count = 0;

            Array.from(automats).forEach(automat => {
                if (automat.tagName === "automat") {
                    let liAutomat = document.createElement("li");
                    liAutomat.className = "folder";

                    // Crear un √≠cono de apertura/cierre
                    let toggleSpan = document.createElement("span");
                    toggleSpan.textContent = "‚ñ∂ ";
                    toggleSpan.style.cursor = "pointer";
                    toggleSpan.classList.add("toggle-icon");

                    let spanText = document.createElement("span");
                    spanText.textContent = automat.getAttribute("name");

                    let ulUnits = document.createElement("ul");
                    ulUnits.className = "tree hidden"; // Ocultar inicialmente

                    let avgStates = extractUnits(automat, ulUnits);
                    totalMajor += avgStates.avgMajor;
                    totalOperational += avgStates.avgOperational;
                    count++;

                    let spanMajor = document.createElement("span");
                    spanMajor.style.color = "red";
                    spanMajor.textContent = ` [Avg Major: ${avgStates.avgMajor.toFixed(2)}]`;

                    let spanOperational = document.createElement("span");
                    spanOperational.style.color = "green";
                    spanOperational.textContent = ` [Avg Operational: ${avgStates.avgOperational.toFixed(2)}]`;

                    // Asegurar que el `ul` es parte del nodo antes de asignar eventos
                    liAutomat.appendChild(toggleSpan);
                    liAutomat.appendChild(spanText);
                    liAutomat.appendChild(spanMajor);
                    liAutomat.appendChild(spanOperational);
                    liAutomat.appendChild(ulUnits);

                    // Asignar el evento correctamente al nodo de lista
                    liAutomat.addEventListener("click", function (event) { toggleChildren(event, this); });

                    parentElement.appendChild(liAutomat);

                    console.log(`‚úÖ Nodo automat agregado: ${automat.getAttribute("name")}`);
                }
            });

            return count > 0 ? { avgMajor: totalMajor / count, avgOperational: totalOperational / count } : { avgMajor: 1, avgOperational: 1 };
        }


        // ‚úÖ Funci√≥n para abrir/cerrar nodos con depuraci√≥n
        function toggleChildren(event, element) {
            event.stopPropagation(); // Evita que el clic afecte otros elementos

            let childrenContainer = element.querySelector("ul");

            if (!childrenContainer) {
                console.log("‚ùå No se encontr√≥ un contenedor hijo para este nodo.");
                return;
            }

            let isHidden = childrenContainer.classList.contains("hidden");

            // Depuraci√≥n: Ver si el nodo tiene hijos y su estado actual
            console.log(`üîç Estado actual antes del clic: ${isHidden ? "Cerrado" : "Abierto"}`);

            childrenContainer.classList.toggle("hidden", !isHidden); // Alternar clase para mostrar/ocultar

            // Cambiar el s√≠mbolo de expansi√≥n solo si es un nodo que tiene hijos
            let toggleSpan = element.querySelector("span.toggle-icon");
            if (toggleSpan) {
                toggleSpan.textContent = isHidden ? "‚ñº " : "‚ñ∂ ";
            }

            console.log(`üîÑ Nodo ${isHidden ? "expandido" : "colapsado"}`);
        }






        function extractUnits(automatNode, parentElement) {
            const units = automatNode.children;
            let totalMajor = 0, totalOperational = 0, count = 0;

            Array.from(units).forEach(unit => {
                if (unit.tagName === "unit") {
                    const unitName = unit.getAttribute("name");
                    let equipments = unit.getElementsByTagName("equipments")[0];

                    let majorState = equipments ? parseInt(equipments.getAttribute("major-operational-state")) || 1 : 1;
                    let operationalState = equipments ? parseInt(equipments.getAttribute("operational-state")) || 1 : 1;

                    totalMajor += majorState;
                    totalOperational += operationalState;
                    count++;

                    let liUnit = document.createElement("li");
                    liUnit.className = "file";
                    liUnit.innerHTML = `${unitName} 
                    <span style="color:red;">[Major: ${majorState}]</span> 
                    <span style="color:green;">[Operational: ${operationalState}]</span>`;

                    parentElement.appendChild(liUnit);
                }
            });

            return count > 0 ? { avgMajor: totalMajor / count, avgOperational: totalOperational / count } : { avgMajor: 1, avgOperational: 1 };
        }


        function toggleChildren(event, element) {
            event.stopPropagation(); // Evita que el clic se propague a niveles superiores

            let children = element.querySelector("ul");
            if (children) {
                let isHidden = children.classList.contains("hidden");
                children.classList.toggle("hidden", !isHidden); // Mostrar u ocultar los hijos
                element.classList.toggle("open", isHidden); // Cambia el estado del nodo
            }
        }

        // Asegurar que los nodos <unit> no afecten el √°rbol
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".file").forEach(file => {
                file.addEventListener("click", function (event) {
                    event.stopPropagation(); // Evita que el clic en <unit> cierre niveles superiores
                });
            });
        });


        // Extrae los valores de operational-state de cada unit
        function extractUnitStates(unitElement) {
            let equipments = unitElement.querySelectorAll("equipment");
            let totalMajor = 0, totalOperational = 0, count = 0;

            equipments.forEach(equipment => {
                let majorState = parseInt(equipment.getAttribute("major-operational-state")) || 1;
                let operationalState = parseInt(equipment.getAttribute("operational-state")) || 1;
                totalMajor += majorState;
                totalOperational += operationalState;
                count++;
            });

            console.log(`Unit: ${unitElement.textContent.trim()} - Major: ${totalMajor}, Operational: ${totalOperational}, Count: ${count}`);

            return {
                majorState: count > 0 ? totalMajor / count : 1,
                operationalState: count > 0 ? totalOperational / count : 1
            };
        }

        function calculateAverages(node) {
            console.log("Procesando nodo:", node); // Ver si node es null o undefined

            if (!node) {
                console.log("‚ùå El nodo es null o undefined");
                return { avgMajor: 1, avgOperational: 1 };
            }

            let units = node.querySelectorAll(".unit");
            let totalMajor = 0, totalOperational = 0, count = 0;

            units.forEach(unit => {
                let states = extractUnitStates(unit);
                totalMajor += states.majorState;
                totalOperational += states.operationalState;
                count++;
            });

            console.log(`‚úî Formation/Automata: ${node.textContent.trim()} - Avg Major: ${totalMajor}, Avg Operational: ${totalOperational}, Count: ${count}`);

            return {
                avgMajor: count > 0 ? totalMajor / count : 1,
                avgOperational: count > 0 ? totalOperational / count : 1
            };
        }


    </script>

</body>

</html>