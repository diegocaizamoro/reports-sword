<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årbol ORBAT - Explorador de Unidades</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .tree {
            margin-left: 20px;
            list-style-type: none;
        }

        .tree li {
            margin: 5px 0;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .tree .folder::before {
            content: "üìÇ ";
        }

        .tree .folder.open::before {
            content: "üìÅ ";
        }

        .tree .file::before {
            content: "üìÑ ";
        }

        .hidden {
            display: none;
        }

        /* Estilos para las barras de progreso */
        .progress-container {
            width: 100px;
            height: 20px;
            background-color: #ddd;
            border-radius: 5px;
            overflow: hidden;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>

<body>

    <h2>√Årbol de ORBAT - Explorador de Unidades</h2>
    <div id="treeContainer"></div>

    <script>
        window.onload = function () {
            fetch("http://localhost:3000/orbat.xml")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("No se pudo cargar el archivo orbat.xml");
                    }
                    return response.text();
                })
                .then(xmlText => {
                    parseXML(xmlText);
                })
                .catch(error => console.error("Error al cargar el ORBAT:", error));
        };

        function parseXML(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");

            // Buscar el nodo <parties> principal
            const partiesNode = xmlDoc.getElementsByTagName("parties")[0];
            if (!partiesNode) {
                console.error("No se encontr√≥ el nodo <parties>");
                return;
            }

            // Obtener SOLO los <party> dentro de <parties> que tengan type="enemy"
            const parties = Array.from(partiesNode.getElementsByTagName("party"))
                .filter(party => party.getAttribute("type") === "enemy");

            const treeContainer = document.getElementById("treeContainer");
            treeContainer.innerHTML = ""; // Limpiar contenido anterior

            let ul = document.createElement("ul");
            ul.className = "tree";

            parties.forEach(party => {
                const partyName = party.getAttribute("name");

                let liParty = document.createElement("li");
                liParty.textContent = partyName;
                liParty.className = "folder";
                liParty.onclick = function (event) { toggleChildren(event, this); };

                let ulTactical = document.createElement("ul");
                ulTactical.className = "tree hidden";

                const tactical = party.getElementsByTagName("tactical")[0];
                if (tactical) {
                    extractFormations(tactical, ulTactical);
                }

                liParty.appendChild(ulTactical);
                ul.appendChild(liParty);
            });

            treeContainer.appendChild(ul);
        }

        function extractUnits(automatNode, parentElement) {
            // Verificar si el automat pertenece a un <party type="enemy">
            let currentNode = automatNode;
            let isEnemy = false;

            while (currentNode) {
                if (currentNode.tagName === "party") {
                    isEnemy = currentNode.getAttribute("type") === "enemy";
                    break;
                }
                currentNode = currentNode.parentElement;
            }

            if (!isEnemy) return 0; // Salir si no pertenece a un party enemigo

            const units = automatNode.children;
            let operationalValues = [];

            Array.from(units).forEach(unit => {
                if (unit.tagName === "unit") {
                    const unitName = unit.getAttribute("name");
                    let equipments = unit.getElementsByTagName("equipments")[0];

                    let operationalState = equipments && equipments.getAttribute("operational-state")
                        ? parseFloat(equipments.getAttribute("operational-state"))
                        : 0;

                    operationalValues.push(operationalState);

                    let liUnit = document.createElement("li");
                    liUnit.className = "file";
                    liUnit.textContent = unitName;

                    let progressBar = createProgressBar(operationalState, unitName);
                    liUnit.appendChild(progressBar);
                    parentElement.appendChild(liUnit);

                    /*if (unitName === "2/VC 2/4") {
                        console.log(unitName, operationalState);
                        console.log(unit.getElementsByTagName("equipments")[0]);
                    }*/
                }
            });

            let avgOperational = operationalValues.length > 0
                ? operationalValues.reduce((a, b) => a + b, 0) / operationalValues.length
                : 0;

            return avgOperational;
        }


        function extractAutomats(formationNode, parentElement) {
            // Verifica si forma parte de un party enemy
            let current = formationNode;
            let isEnemy = false;

            while (current) {
                if (current.tagName === "party") {
                    isEnemy = current.getAttribute("type") === "enemy";
                    break;
                }
                current = current.parentElement;
            }

            if (!isEnemy) return 0; // Ignora si no es enemigo

            const automats = formationNode.children;
            let operationalValues = [];

            Array.from(automats).forEach(automat => {
                if (automat.tagName === "automat") {
                    let liAutomat = document.createElement("li");
                    liAutomat.className = "folder";
                    liAutomat.textContent = automat.getAttribute("name");

                    let ulUnits = document.createElement("ul");
                    ulUnits.className = "tree hidden";

                    let avgOperational = extractUnits(automat, ulUnits);
                    operationalValues.push(avgOperational);

                    let progressBar = createProgressBar(avgOperational, liAutomat.textContent);
                    liAutomat.appendChild(progressBar);
                    liAutomat.appendChild(ulUnits);
                    liAutomat.onclick = function (event) { toggleChildren(event, this); };

                    parentElement.appendChild(liAutomat);
                }
            });

            return operationalValues.length > 0
                ? operationalValues.reduce((a, b) => a + b, 0) / operationalValues.length
                : 0;
        }


        function extractFormations(parentNode, parentElement) {
            // Verifica si forma parte de un party enemy
            let current = parentNode;
            let isEnemy = false;

            while (current) {
                if (current.tagName === "party") {
                    isEnemy = current.getAttribute("type") === "enemy";
                    break;
                }
                current = current.parentElement;
            }

            if (!isEnemy) return 0; // Ignora si no es enemigo

            //const formations = parentNode.children;
            const formations = Array.from(parentNode.children).filter(child => child.tagName === "formation");
            let totalOperationalValues = [];
            if (parentNode.getAttribute("name") === "10BIM ") {
                formations.forEach(formation => {
                    const name = formation.getAttribute("name");
                    console.log("Hija de", parentNode.getAttribute("name"), "‚Üí", name);
                });
            }

            Array.from(formations).forEach(formation => {
                if (formation.tagName === "formation") {
                    const formationName = formation.getAttribute("name");

                    let liFormation = document.createElement("li");
                    liFormation.textContent = formationName;
                    liFormation.className = "folder";
                    liFormation.onclick = function (event) { toggleChildren(event, this); };

                    let ulSubFormations = document.createElement("ul");
                    ulSubFormations.className = "tree hidden";

                    let operationalValues = [];
                    let hasContent = false;

                    let automatAvg = extractAutomats(formation, ulSubFormations);
                    if (!isNaN(automatAvg) && automatAvg > 0) {
                        operationalValues.push(automatAvg);
                        hasContent = true;
                    }

                    let childFormationAvg = extractFormations(formation, ulSubFormations);
                    if (!isNaN(childFormationAvg) && childFormationAvg > 0) {
                        operationalValues.push(childFormationAvg);
                        hasContent = true;

                    }
                    if (!hasContent) {
                        // Podr√≠as asumir que si no tiene hijos, el progreso es 0.
                        operationalValues.push(0);
                    }

                    let avgOperational = operationalValues.length > 0
                        ? operationalValues.reduce((a, b) => a + b, 0) / operationalValues.length
                        : 0;


                    /*if (parentNode.getAttribute("name") === "14BCB ") {
                        console.log(automatAvg);
                    }*/



                    let progressBar = createProgressBar(avgOperational, formationName);
                    liFormation.appendChild(progressBar);
                    liFormation.appendChild(ulSubFormations);
                    parentElement.appendChild(liFormation);

                    totalOperationalValues.push(avgOperational);
                }
            });

            return totalOperationalValues.length > 0
                ? totalOperationalValues.reduce((a, b) => a + b, 0) / totalOperationalValues.length
                : 0;
        }


        function createProgressBar(value, unitName) {
            let percentage = Math.max(0, Math.min(value * 100, 100));

            let color = percentage < 34 ? "#f4a9a9" : percentage < 67 ? "yellow" : "#99e699";


            let container = document.createElement("div");
            container.className = "progress-container";
            container.setAttribute("name", unitName);  // Asigna el nombre de la unidad al contenedor

            let bar = document.createElement("div");
            bar.className = "progress-bar";
            bar.style.width = percentage + "%";
            bar.style.backgroundColor = color;
            bar.style.position = "relative";
            bar.style.textAlign = "center";
            bar.style.color = "black";
            bar.style.fontSize = "15px";
            bar.style.lineHeight = "15px"; // Centrar el texto verticalmente
            bar.textContent = Math.floor(percentage) + "%"; // Agregar el porcentaje dentro de la barra

            container.appendChild(bar);
            return container;
        }

        function toggleChildren(event, element) {
            event.stopPropagation();
            let children = element.querySelector("ul");
            if (children) {
                let isHidden = children.classList.contains("hidden");
                children.classList.toggle("hidden", !isHidden);
                element.classList.toggle("open", isHidden);
            }
        }




        // Refrescar valores de orbat.xml cada 8s sin reconstruir el √°rbol
        setInterval(() => {
            fetch("http://localhost:3000/orbat.xml")
                .then(response => response.text())
                .then(xmlText => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    updateOperationalValues(xmlDoc);
                })
                .catch(err => console.error("Error actualizando valores ORBAT:", err));
        }, 800000);

        // Escapar nombre seguro
        function cssEscape(str) {
            return str.replace(/([ !"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~])/g, '\\$1');
        }

        function updateOperationalValues(xmlDoc) {
            // Obtener solo los <party> con type="enemy"
            const parties = Array.from(xmlDoc.getElementsByTagName("party"))
                .filter(party => party.getAttribute("type") === "enemy");

            parties.forEach(party => {
                const unitMap = new Map(); // üëà Se mantiene aqu√≠ dentro para cada party
                const tactical = party.querySelector("tactical");

                if (!tactical) return;

                // ========== 1. UNITS ==========
                const automats = tactical.getElementsByTagName("automat");

                Array.from(automats).forEach(automat => {
                    const units = Array.from(automat.getElementsByTagName("unit")).filter(u => u.parentNode === automat);

                    units.forEach(unit => {
                        const unitName = unit.getAttribute("name");
                        const equipments = unit.getElementsByTagName("equipments")[0];
                        const operationalState = equipments && equipments.getAttribute("operational-state")
                            ? parseFloat(equipments.getAttribute("operational-state"))
                            : 0;

                        if (!unitMap.has(unitName)) {
                            unitMap.set(unitName, operationalState);

                            const safeName = cssEscape(unitName);
                            const container = document.querySelector(`.progress-container[name="${safeName}"]`);
                            if (container) updateProgressBar(container, operationalState);

                            //console.log("Unidad:", unitName, "‚Üí", operationalState);
                        }
                    });
                });

                // ========== 2. AUTOMATS ==========
                Array.from(automats).forEach(automat => {
                    const automatName = automat.getAttribute("name");
                    const unitNodes = Array.from(automat.getElementsByTagName("unit")).filter(u => u.parentNode === automat);

                    let total = 0;
                    let count = 0;

                    unitNodes.forEach(unit => {
                        const name = unit.getAttribute("name");
                        if (unitMap.has(name)) {
                            total += unitMap.get(name);
                            count++;
                        }
                    });

                    const avg = count > 0 ? total / count : 0;
                    unitMap.set(automatName, avg);

                    const safeName = cssEscape(automatName);
                    const container = document.querySelector(`.progress-container[name="${safeName}"]`);
                    if (container) updateProgressBar(container, avg);

                    //console.log("Automat:", automatName, "‚Üí", avg);
                });

                // ========== 3. FORMATIONS (bottom-up) ==========
                const formations = Array.from(tactical.getElementsByTagName("formation")).reverse();

                formations.forEach(formation => {
                    const formationName = formation.getAttribute("name");

                    let total = 0;
                    let count = 0;

                    const automatNodes = Array.from(formation.getElementsByTagName("automat"))
                        .filter(a => a.parentNode === formation);
                    automatNodes.forEach(automat => {
                        const name = automat.getAttribute("name");
                        if (unitMap.has(name)) {
                            total += unitMap.get(name);
                            count++;
                        }
                    });

                    const subFormations = Array.from(formation.getElementsByTagName("formation"))
                        .filter(f => f.parentNode === formation);
                    subFormations.forEach(sub => {
                        const name = sub.getAttribute("name");
                        if (unitMap.has(name)) {
                            total += unitMap.get(name);
                            count++;
                        }
                    });

                    const avg = count > 0 ? total / count : 0;
                    unitMap.set(formationName, avg);

                    const safeName = cssEscape(formationName);
                    const container = document.querySelector(`.progress-container[name="${safeName}"]`);
                    if (container) updateProgressBar(container, avg);

                    //console.log("Formaci√≥n:", formationName, "‚Üí", avg);
                });

                // ========== 4. PARTY ==========
                const partyName = party.getAttribute("name");

                let total = 0;
                let count = 0;

                const rootFormations = Array.from(tactical.getElementsByTagName("formation"))
                    .filter(f => f.parentNode === tactical);
                rootFormations.forEach(formation => {
                    const name = formation.getAttribute("name");
                    if (unitMap.has(name)) {
                        total += unitMap.get(name);
                        count++;
                    }
                });

                const avg = count > 0 ? total / count : 0;
                unitMap.set(partyName, avg);

                const safeName = cssEscape(partyName);
                const container = document.querySelector(`.progress-container[name="${safeName}"]`);
                if (container) updateProgressBar(container, avg);

                //console.log("Party:", partyName, "‚Üí", avg);
            });
        }



        function updateProgressBar(container, value) {
            const bar = container.querySelector(".progress-bar");

            const percentage = Math.max(0, Math.min(value * 100, 100));
            const color = percentage < 34 ? "#f4a9a9" : percentage < 67 ? "yellow" : "#99e699";

            bar.style.width = percentage + "%";
            bar.style.backgroundColor = color;
            bar.textContent = Math.floor(percentage) + "%";
        }

    </script>

</body>

</html>